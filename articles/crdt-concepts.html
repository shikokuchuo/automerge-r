<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Understanding CRDTs in Automerge • automerge</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Understanding CRDTs in Automerge">
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">automerge</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/automerge.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/crdt-concepts.html">Understanding CRDTs in Automerge</a></li>
    <li><a class="dropdown-item" href="../articles/sync-protocol.html">Synchronization Protocol</a></li>
    <li><a class="dropdown-item" href="../articles/very-quick-reference.html">Quick Reference</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/shikokuchuo/automerge-r/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Understanding CRDTs in Automerge</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/shikokuchuo/automerge-r/blob/main/vignettes/crdt-concepts.Rmd" class="external-link"><code>vignettes/crdt-concepts.Rmd</code></a></small>
      <div class="d-none name"><code>crdt-concepts.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/shikokuchuo/automerge-r" class="external-link">automerge</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="what-are-crdts">What are CRDTs?<a class="anchor" aria-label="anchor" href="#what-are-crdts"></a>
</h2>
<p>Conflict-free Replicated Data Types (CRDTs) are data structures that
can be replicated across multiple computers and modified independently
without coordination. The key property is that when all changes are
eventually synchronized, all replicas converge to the same state
automatically - without manual conflict resolution.</p>
<div class="section level3">
<h3 id="the-problem-crdts-solve">The Problem CRDTs Solve<a class="anchor" aria-label="anchor" href="#the-problem-crdts-solve"></a>
</h3>
<p>Consider a simple example without CRDTs:</p>
<pre><code>Initial state: counter = 0

Alice's device (offline): counter = counter + 1  → counter = 1
Bob's device (offline):   counter = counter + 2  → counter = 2

When they sync:
- If we use "last write wins": counter = 2 (Alice's change lost!)
- If we use "first write wins": counter = 1 (Bob's change lost!)
- Manual conflict resolution: Ask user to choose (annoying!)</code></pre>
<p>With a CRDT counter:</p>
<pre><code>Initial state: counter = 0

Alice's device: increment(1)
Bob's device:   increment(2)

When they sync:
- CRDT automatically merges: counter = 3 (both changes preserved!)</code></pre>
</div>
<div class="section level3">
<h3 id="crdt-properties">CRDT Properties<a class="anchor" aria-label="anchor" href="#crdt-properties"></a>
</h3>
<p>All CRDTs have these properties:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Associativity</strong>: The order of merging doesn’t matter
<ul>
<li><code>merge(merge(A, B), C) = merge(A, merge(B, C))</code></li>
</ul>
</li>
<li>
<strong>Commutativity</strong>: Who merges with whom doesn’t matter
<ul>
<li><code>merge(A, B) = merge(B, A)</code></li>
</ul>
</li>
<li>
<strong>Idempotency</strong>: Merging the same change multiple times
has no additional effect
<ul>
<li><code>merge(A, A) = A</code></li>
</ul>
</li>
</ol>
<p>These properties ensure <strong>strong eventual consistency</strong>:
all devices that see the same set of changes will converge to the same
state, regardless of network delays, message reordering, or
duplicates.</p>
</div>
</div>
<div class="section level2">
<h2 id="automerge-crdt-types">Automerge CRDT Types<a class="anchor" aria-label="anchor" href="#automerge-crdt-types"></a>
</h2>
<p>Automerge implements several CRDT types, each optimized for different
use cases.</p>
<div class="section level3">
<h3 id="register-values-strings-numbers-booleans">Register Values (Strings, Numbers, Booleans)<a class="anchor" aria-label="anchor" href="#register-values-strings-numbers-booleans"></a>
</h3>
<p>The simplest type: when two replicas concurrently write different
values to the same key, one value wins. Automerge uses a deterministic
conflict resolution algorithm (based on Lamport timestamps and actor
IDs) to ensure all replicas converge to the same value.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doc1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">doc1</span><span class="op">[[</span><span class="st">"name"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Alice"</span></span>
<span><span class="va">doc1</span><span class="op">[[</span><span class="st">"score"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">doc2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_fork.html">am_fork</a></span><span class="op">(</span><span class="va">doc1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Concurrent edits</span></span>
<span><span class="va">doc1</span><span class="op">[[</span><span class="st">"name"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Alice Smith"</span></span>
<span><span class="va">doc2</span><span class="op">[[</span><span class="st">"name"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Alice Johnson"</span></span>
<span></span>
<span><span class="co"># Merge</span></span>
<span><span class="fu"><a href="../reference/am_merge.html">am_merge</a></span><span class="op">(</span><span class="va">doc1</span>, <span class="va">doc2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># One value wins (deterministic, all replicas agree)</span></span>
<span><span class="va">doc1</span><span class="op">[[</span><span class="st">"name"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "Alice Johnson"</span></span></code></pre></div>
<p><strong>When to use</strong>: Simple values where automatic conflict
resolution is acceptable (metadata, settings, labels).</p>
<p><strong>Trade-off</strong>: One concurrent change is lost, but
resolution is deterministic and all replicas converge to the same
state.</p>
</div>
<div class="section level3">
<h3 id="maps-nested-objects">Maps (Nested Objects)<a class="anchor" aria-label="anchor" href="#maps-nested-objects"></a>
</h3>
<p>Maps are collections of key-value pairs. Each key uses deterministic
conflict resolution (one value wins), but different keys can be edited
concurrently without conflict.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doc3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">doc3</span><span class="op">[[</span><span class="st">"user"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Alice"</span>, age <span class="op">=</span> <span class="fl">30L</span>, city <span class="op">=</span> <span class="st">"Boston"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">doc4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_fork.html">am_fork</a></span><span class="op">(</span><span class="va">doc3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Concurrent edits to different keys</span></span>
<span><span class="va">user3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get.html">am_get</a></span><span class="op">(</span><span class="va">doc3</span>, <span class="va">AM_ROOT</span>, <span class="st">"user"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_put.html">am_put</a></span><span class="op">(</span><span class="va">doc3</span>, <span class="va">user3</span>, <span class="st">"age"</span>, <span class="fl">31L</span><span class="op">)</span></span>
<span></span>
<span><span class="va">user4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get.html">am_get</a></span><span class="op">(</span><span class="va">doc4</span>, <span class="va">AM_ROOT</span>, <span class="st">"user"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_put.html">am_put</a></span><span class="op">(</span><span class="va">doc4</span>, <span class="va">user4</span>, <span class="st">"city"</span>, <span class="st">"New York"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Merge - both changes preserved</span></span>
<span><span class="fu"><a href="../reference/am_merge.html">am_merge</a></span><span class="op">(</span><span class="va">doc3</span>, <span class="va">doc4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Both edits are present</span></span>
<span><span class="va">user_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get.html">am_get</a></span><span class="op">(</span><span class="va">doc3</span>, <span class="va">AM_ROOT</span>, <span class="st">"user"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_get.html">am_get</a></span><span class="op">(</span><span class="va">doc3</span>, <span class="va">user_final</span>, <span class="st">"age"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 31</span></span>
<span><span class="fu"><a href="../reference/am_get.html">am_get</a></span><span class="op">(</span><span class="va">doc3</span>, <span class="va">user_final</span>, <span class="st">"city"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "New York"</span></span></code></pre></div>
<p><strong>When to use</strong>: Structured data with multiple
independent fields (user profiles, configuration objects).</p>
<p><strong>Merge behavior</strong>: Changes to different keys merge
cleanly. Changes to the same key use deterministic conflict
resolution.</p>
</div>
<div class="section level3">
<h3 id="lists-ordered-sequences">Lists (Ordered Sequences)<a class="anchor" aria-label="anchor" href="#lists-ordered-sequences"></a>
</h3>
<p>Lists use a sophisticated CRDT algorithm that preserves insertion
order and handles concurrent insertions elegantly.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doc5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_put.html">am_put</a></span><span class="op">(</span><span class="va">doc5</span>, <span class="va">AM_ROOT</span>, <span class="st">"items"</span>, <span class="va">AM_OBJ_TYPE_LIST</span><span class="op">)</span></span>
<span><span class="va">items5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get.html">am_get</a></span><span class="op">(</span><span class="va">doc5</span>, <span class="va">AM_ROOT</span>, <span class="st">"items"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/am_put.html">am_put</a></span><span class="op">(</span><span class="va">doc5</span>, <span class="va">items5</span>, <span class="st">"end"</span>, <span class="st">"A"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_put.html">am_put</a></span><span class="op">(</span><span class="va">doc5</span>, <span class="va">items5</span>, <span class="st">"end"</span>, <span class="st">"C"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">doc6</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_fork.html">am_fork</a></span><span class="op">(</span><span class="va">doc5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Concurrent insertions at same position</span></span>
<span><span class="va">items6</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get.html">am_get</a></span><span class="op">(</span><span class="va">doc6</span>, <span class="va">AM_ROOT</span>, <span class="st">"items"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_insert.html">am_insert</a></span><span class="op">(</span><span class="va">doc5</span>, <span class="va">items5</span>, <span class="fl">2</span>, <span class="st">"B1"</span><span class="op">)</span> <span class="co"># Insert between A and C</span></span>
<span><span class="fu"><a href="../reference/am_insert.html">am_insert</a></span><span class="op">(</span><span class="va">doc6</span>, <span class="va">items6</span>, <span class="fl">2</span>, <span class="st">"B2"</span><span class="op">)</span> <span class="co"># Insert between A and C</span></span>
<span></span>
<span><span class="co"># Merge</span></span>
<span><span class="fu"><a href="../reference/am_merge.html">am_merge</a></span><span class="op">(</span><span class="va">doc5</span>, <span class="va">doc6</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Both insertions preserved with deterministic ordering</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="../reference/am_length.html">am_length</a></span><span class="op">(</span><span class="va">doc5</span>, <span class="va">items5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="../reference/am_get.html">am_get</a></span><span class="op">(</span><span class="va">doc5</span>, <span class="va">items5</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] "A"</span></span>
<span><span class="co">#&gt; [1] "B2"</span></span>
<span><span class="co">#&gt; [1] "B1"</span></span>
<span><span class="co">#&gt; [1] "C"</span></span></code></pre></div>
<p><strong>When to use</strong>: Ordered collections (task lists,
sequences, timelines).</p>
<p><strong>Merge behavior</strong>: Concurrent insertions at the same
position are both preserved. The algorithm ensures deterministic
ordering based on actor IDs.</p>
<p><strong>Limitation</strong>: There are cases where insertion order is
not perfectly preserved, primarily when inserting elements in reverse
order. However, the algorithm performs well in most common
scenarios.</p>
</div>
<div class="section level3">
<h3 id="text-crdts-collaborative-text-editing">Text CRDTs (Collaborative Text Editing)<a class="anchor" aria-label="anchor" href="#text-crdts-collaborative-text-editing"></a>
</h3>
<p>Text objects are optimized for character-level collaborative editing.
They handle concurrent insertions, deletions, and edits gracefully.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doc7</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_put.html">am_put</a></span><span class="op">(</span><span class="va">doc7</span>, <span class="va">AM_ROOT</span>, <span class="st">"document"</span>, <span class="fu"><a href="../reference/am_text.html">am_text</a></span><span class="op">(</span><span class="st">"The quick fox jumps"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc7</span><span class="op">)</span></span>
<span></span>
<span><span class="va">doc8</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_fork.html">am_fork</a></span><span class="op">(</span><span class="va">doc7</span><span class="op">)</span></span>
<span></span>
<span><span class="va">text7</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get.html">am_get</a></span><span class="op">(</span><span class="va">doc7</span>, <span class="va">AM_ROOT</span>, <span class="st">"document"</span><span class="op">)</span></span>
<span><span class="va">text8</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get.html">am_get</a></span><span class="op">(</span><span class="va">doc8</span>, <span class="va">AM_ROOT</span>, <span class="st">"document"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Concurrent edits (0-based inter-character positions)</span></span>
<span><span class="fu"><a href="../reference/am_text_splice.html">am_text_splice</a></span><span class="op">(</span><span class="va">text7</span>, <span class="fl">10</span>, <span class="fl">0</span>, <span class="st">"brown "</span><span class="op">)</span> <span class="co"># Insert "brown " at position 10</span></span>
<span><span class="fu"><a href="../reference/am_text_splice.html">am_text_splice</a></span><span class="op">(</span><span class="va">text8</span>, <span class="fl">19</span>, <span class="fl">0</span>, <span class="st">" high"</span><span class="op">)</span> <span class="co"># Insert " high" at position 19 (end)</span></span>
<span></span>
<span><span class="co"># Merge</span></span>
<span><span class="fu"><a href="../reference/am_merge.html">am_merge</a></span><span class="op">(</span><span class="va">doc7</span>, <span class="va">doc8</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Both edits preserved</span></span>
<span><span class="fu"><a href="../reference/am_text_get.html">am_text_get</a></span><span class="op">(</span><span class="va">text7</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "The quick brown fox jumps high"</span></span></code></pre></div>
<p><strong>When to use</strong>: Collaborative documents, shared notes,
code editors, chat messages.</p>
<p><strong>Merge behavior</strong>: Character-level operations merge
intelligently. Positions are tracked using stable identifiers, so
concurrent edits at different positions don’t interfere.</p>
<p><strong>Important</strong>: Regular strings
(<code>AM_VAL_TYPE_STR</code>) use deterministic conflict resolution
(one value wins). Only text objects (<code>AM_OBJ_TYPE_TEXT</code>)
provide character-level CRDT merging.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># String (deterministic conflict resolution)</span></span>
<span><span class="va">doc9</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">doc9</span><span class="op">[[</span><span class="st">"title"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Document"</span></span>
<span><span class="va">doc10</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_fork.html">am_fork</a></span><span class="op">(</span><span class="va">doc9</span><span class="op">)</span></span>
<span></span>
<span><span class="va">doc9</span><span class="op">[[</span><span class="st">"title"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"My Document"</span></span>
<span><span class="va">doc10</span><span class="op">[[</span><span class="st">"title"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Our Document"</span></span>
<span><span class="fu"><a href="../reference/am_merge.html">am_merge</a></span><span class="op">(</span><span class="va">doc9</span>, <span class="va">doc10</span><span class="op">)</span></span>
<span><span class="va">doc9</span><span class="op">[[</span><span class="st">"title"</span><span class="op">]</span><span class="op">]</span> <span class="co"># One value wins deterministically</span></span>
<span><span class="co">#&gt; [1] "Our Document"</span></span>
<span></span>
<span><span class="co"># Text object (CRDT)</span></span>
<span><span class="va">doc11</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_put.html">am_put</a></span><span class="op">(</span><span class="va">doc11</span>, <span class="va">AM_ROOT</span>, <span class="st">"content"</span>, <span class="fu"><a href="../reference/am_text.html">am_text</a></span><span class="op">(</span><span class="st">"Hello"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">doc12</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_fork.html">am_fork</a></span><span class="op">(</span><span class="va">doc11</span><span class="op">)</span></span>
<span></span>
<span><span class="va">text11</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get.html">am_get</a></span><span class="op">(</span><span class="va">doc11</span>, <span class="va">AM_ROOT</span>, <span class="st">"content"</span><span class="op">)</span></span>
<span><span class="va">text12</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get.html">am_get</a></span><span class="op">(</span><span class="va">doc12</span>, <span class="va">AM_ROOT</span>, <span class="st">"content"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/am_text_splice.html">am_text_splice</a></span><span class="op">(</span><span class="va">text11</span>, <span class="fl">5</span>, <span class="fl">0</span>, <span class="st">" World"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_text_splice.html">am_text_splice</a></span><span class="op">(</span><span class="va">text12</span>, <span class="fl">5</span>, <span class="fl">0</span>, <span class="st">" Everyone"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_merge.html">am_merge</a></span><span class="op">(</span><span class="va">doc11</span>, <span class="va">doc12</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/am_text_get.html">am_text_get</a></span><span class="op">(</span><span class="va">text11</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Hello World Everyone"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="counters">Counters<a class="anchor" aria-label="anchor" href="#counters"></a>
</h3>
<p>Counters are a classic CRDT that adds up increments from all
replicas.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doc13</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_put.html">am_put</a></span><span class="op">(</span><span class="va">doc13</span>, <span class="va">AM_ROOT</span>, <span class="st">"likes"</span>, <span class="fu"><a href="../reference/am_counter.html">am_counter</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc13</span><span class="op">)</span></span>
<span></span>
<span><span class="va">doc14</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_fork.html">am_fork</a></span><span class="op">(</span><span class="va">doc13</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Concurrent increments</span></span>
<span><span class="fu"><a href="../reference/am_counter_increment.html">am_counter_increment</a></span><span class="op">(</span><span class="va">doc13</span>, <span class="va">AM_ROOT</span>, <span class="st">"likes"</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_counter_increment.html">am_counter_increment</a></span><span class="op">(</span><span class="va">doc14</span>, <span class="va">AM_ROOT</span>, <span class="st">"likes"</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_counter_increment.html">am_counter_increment</a></span><span class="op">(</span><span class="va">doc14</span>, <span class="va">AM_ROOT</span>, <span class="st">"likes"</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Merge</span></span>
<span><span class="fu"><a href="../reference/am_merge.html">am_merge</a></span><span class="op">(</span><span class="va">doc13</span>, <span class="va">doc14</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sum of all increments</span></span>
<span><span class="va">doc13</span><span class="op">[[</span><span class="st">"likes"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; &lt;Automerge Counter: 7 &gt;</span></span></code></pre></div>
<p><strong>When to use</strong>: Vote counts, like counts, inventory
quantities, collaborative counters.</p>
<p><strong>Merge behavior</strong>: All increments (positive or
negative) are summed automatically.</p>
</div>
<div class="section level3">
<h3 id="timestamps">Timestamps<a class="anchor" aria-label="anchor" href="#timestamps"></a>
</h3>
<p>Timestamps record when a value was set. They use deterministic
conflict resolution semantics (one value wins).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doc15</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">doc15</span><span class="op">[[</span><span class="st">"created_at"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc15</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">doc16</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_fork.html">am_fork</a></span><span class="op">(</span><span class="va">doc15</span><span class="op">)</span></span>
<span></span>
<span><span class="va">doc15</span><span class="op">[[</span><span class="st">"updated_at"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">doc16</span><span class="op">[[</span><span class="st">"updated_at"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/am_merge.html">am_merge</a></span><span class="op">(</span><span class="va">doc15</span>, <span class="va">doc16</span><span class="op">)</span></span>
<span></span>
<span><span class="va">doc15</span><span class="op">[[</span><span class="st">"created_at"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "2025-11-26 10:39:48 UTC"</span></span>
<span><span class="va">doc15</span><span class="op">[[</span><span class="st">"updated_at"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "2025-11-26 10:39:48 UTC"</span></span></code></pre></div>
<p><strong>When to use</strong>: Audit trails, modification times,
temporal metadata.</p>
</div>
</div>
<div class="section level2">
<h2 id="advanced-text-features">Advanced Text Features<a class="anchor" aria-label="anchor" href="#advanced-text-features"></a>
</h2>
<div class="section level3">
<h3 id="cursors-stable-position-tracking">Cursors (Stable Position Tracking)<a class="anchor" aria-label="anchor" href="#cursors-stable-position-tracking"></a>
</h3>
<p>Cursors maintain stable positions in text even as the document is
edited.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doc17</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_put.html">am_put</a></span><span class="op">(</span><span class="va">doc17</span>, <span class="va">AM_ROOT</span>, <span class="st">"text"</span>, <span class="fu"><a href="../reference/am_text.html">am_text</a></span><span class="op">(</span><span class="st">"Hello World"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">text17</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get.html">am_get</a></span><span class="op">(</span><span class="va">doc17</span>, <span class="va">AM_ROOT</span>, <span class="st">"text"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create cursor at position 6 (0-based: after "Hello ")</span></span>
<span><span class="va">cursor</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_cursor.html">am_cursor</a></span><span class="op">(</span><span class="va">text17</span>, <span class="fl">6</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Insert text before cursor</span></span>
<span><span class="fu"><a href="../reference/am_text_splice.html">am_text_splice</a></span><span class="op">(</span><span class="va">text17</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="st">"Hi "</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Cursor automatically adjusts</span></span>
<span><span class="va">new_pos</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_cursor_position.html">am_cursor_position</a></span><span class="op">(</span><span class="va">text17</span>, <span class="va">cursor</span><span class="op">)</span></span>
<span><span class="va">new_pos</span> <span class="co"># Cursor moved with text from original position 6</span></span>
<span><span class="co">#&gt; [1] 9</span></span></code></pre></div>
<p><strong>When to use</strong>: Text editors (cursor tracking),
collaborative commenting (position references).</p>
</div>
<div class="section level3">
<h3 id="marks-text-formatting">Marks (Text Formatting)<a class="anchor" aria-label="anchor" href="#marks-text-formatting"></a>
</h3>
<p>Marks attach metadata to text ranges, useful for formatting and
annotations.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doc18</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_put.html">am_put</a></span><span class="op">(</span><span class="va">doc18</span>, <span class="va">AM_ROOT</span>, <span class="st">"text"</span>, <span class="fu"><a href="../reference/am_text.html">am_text</a></span><span class="op">(</span><span class="st">"Hello World"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">text18</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get.html">am_get</a></span><span class="op">(</span><span class="va">doc18</span>, <span class="va">AM_ROOT</span>, <span class="st">"text"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Mark "Hello" as bold (positions 0-4, 0-based)</span></span>
<span><span class="fu"><a href="../reference/am_mark_create.html">am_mark_create</a></span><span class="op">(</span><span class="va">text18</span>, <span class="fl">0</span>, <span class="fl">5</span>, <span class="st">"bold"</span>, <span class="cn">TRUE</span>, expand <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Mark "World" as italic (positions 6-10)</span></span>
<span><span class="fu"><a href="../reference/am_mark_create.html">am_mark_create</a></span><span class="op">(</span><span class="va">text18</span>, <span class="fl">6</span>, <span class="fl">11</span>, <span class="st">"italic"</span>, <span class="cn">TRUE</span>, expand <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Query marks</span></span>
<span><span class="va">marks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_marks.html">am_marks</a></span><span class="op">(</span><span class="va">text18</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">marks</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 2</span></span>
<span><span class="co">#&gt;  $ :List of 4</span></span>
<span><span class="co">#&gt;   ..$ name : chr "bold"</span></span>
<span><span class="co">#&gt;   ..$ value: logi TRUE</span></span>
<span><span class="co">#&gt;   ..$ start: int 0</span></span>
<span><span class="co">#&gt;   ..$ end  : int 5</span></span>
<span><span class="co">#&gt;  $ :List of 4</span></span>
<span><span class="co">#&gt;   ..$ name : chr "italic"</span></span>
<span><span class="co">#&gt;   ..$ value: logi TRUE</span></span>
<span><span class="co">#&gt;   ..$ start: int 6</span></span>
<span><span class="co">#&gt;   ..$ end  : int 11</span></span>
<span></span>
<span><span class="co"># Marks at specific position</span></span>
<span><span class="va">marks_at_pos</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_marks_at.html">am_marks_at</a></span><span class="op">(</span><span class="va">text18</span>, <span class="fl">2</span><span class="op">)</span> <span class="co"># Position 2 (in "Hello")</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">marks_at_pos</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 1</span></span>
<span><span class="co">#&gt;  $ :List of 4</span></span>
<span><span class="co">#&gt;   ..$ name : chr "bold"</span></span>
<span><span class="co">#&gt;   ..$ value: logi TRUE</span></span>
<span><span class="co">#&gt;   ..$ start: int 0</span></span>
<span><span class="co">#&gt;   ..$ end  : int 5</span></span></code></pre></div>
<p><strong>When to use</strong>: Rich text editors, collaborative
annotations, syntax highlighting.</p>
<p><strong>Mark expansion</strong>: Controls how marks behave when text
is inserted at boundaries: - <code>"none"</code>: Mark doesn’t expand -
<code>"before"</code>: Expands to include text inserted before start -
<code>"after"</code>: Expands to include text inserted after end -
<code>"both"</code>: Expands at both boundaries</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doc19</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_put.html">am_put</a></span><span class="op">(</span><span class="va">doc19</span>, <span class="va">AM_ROOT</span>, <span class="st">"text"</span>, <span class="fu"><a href="../reference/am_text.html">am_text</a></span><span class="op">(</span><span class="st">"Hello"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">text19</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get.html">am_get</a></span><span class="op">(</span><span class="va">doc19</span>, <span class="va">AM_ROOT</span>, <span class="st">"text"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Mark with expansion</span></span>
<span><span class="fu"><a href="../reference/am_mark_create.html">am_mark_create</a></span><span class="op">(</span><span class="va">text19</span>, <span class="fl">0</span>, <span class="fl">5</span>, <span class="st">"bold"</span>, <span class="cn">TRUE</span>, expand <span class="op">=</span> <span class="st">"after"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Insert at end of mark</span></span>
<span><span class="fu"><a href="../reference/am_text_splice.html">am_text_splice</a></span><span class="op">(</span><span class="va">text19</span>, <span class="fl">5</span>, <span class="fl">0</span>, <span class="st">" World"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Mark expands to include "World"</span></span>
<span><span class="va">marks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_marks.html">am_marks</a></span><span class="op">(</span><span class="va">text19</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">marks</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 1</span></span>
<span><span class="co">#&gt;  $ :List of 4</span></span>
<span><span class="co">#&gt;   ..$ name : chr "bold"</span></span>
<span><span class="co">#&gt;   ..$ value: logi TRUE</span></span>
<span><span class="co">#&gt;   ..$ start: int 0</span></span>
<span><span class="co">#&gt;   ..$ end  : int 11</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="crdt-design-trade-offs">CRDT Design Trade-offs<a class="anchor" aria-label="anchor" href="#crdt-design-trade-offs"></a>
</h2>
<div class="section level3">
<h3 id="storage-growth">Storage Growth<a class="anchor" aria-label="anchor" href="#storage-growth"></a>
</h3>
<p>CRDTs preserve operation history to enable merging. This means
document size grows with the number of operations, not just current
content size.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doc20</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make many edits</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">doc20</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"key"</span>, <span class="va">i</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">i</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc20</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Size includes all history</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="../reference/am_save.html">am_save</a></span><span class="op">(</span><span class="va">doc20</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 508</span></span></code></pre></div>
<p><strong>Mitigation strategies</strong>:</p>
<ol style="list-style-type: decimal">
<li>Commit less frequently for bulk changes</li>
<li>Compact history periodically (future feature)</li>
<li>Use appropriate granularity (don’t make objects too
fine-grained)</li>
</ol>
</div>
<div class="section level3">
<h3 id="deletions-and-concurrent-operations">Deletions and Concurrent Operations<a class="anchor" aria-label="anchor" href="#deletions-and-concurrent-operations"></a>
</h3>
<p>Deleted items leave tombstones to ensure consistent deletion across
replicas. When a delete operation conflicts with an update operation,
Automerge has specific resolution rules:</p>
<p><strong>Maps and Lists</strong>: When one replica deletes a
key/element while another updates it concurrently, the update takes
precedence. The updated value is retained in the merged document.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Map: Deletion vs concurrent update - update wins</span></span>
<span><span class="va">doc21</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">doc21</span><span class="op">[[</span><span class="st">"temp"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"value"</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc21</span><span class="op">)</span></span>
<span></span>
<span><span class="va">doc22</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_fork.html">am_fork</a></span><span class="op">(</span><span class="va">doc21</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/am_delete.html">am_delete</a></span><span class="op">(</span><span class="va">doc21</span>, <span class="va">AM_ROOT</span>, <span class="st">"temp"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc21</span><span class="op">)</span></span>
<span></span>
<span><span class="va">doc22</span><span class="op">[[</span><span class="st">"temp"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"updated"</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc22</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/am_merge.html">am_merge</a></span><span class="op">(</span><span class="va">doc21</span>, <span class="va">doc22</span><span class="op">)</span></span>
<span><span class="va">doc21</span><span class="op">[[</span><span class="st">"temp"</span><span class="op">]</span><span class="op">]</span> <span class="co"># Update takes precedence over delete</span></span>
<span><span class="co">#&gt; [1] "updated"</span></span></code></pre></div>
<p><strong>Double deletion</strong>: When both replicas delete the same
key/element, the key/element is removed from the merged document.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># List: Delete and insert at same position - both operations apply</span></span>
<span><span class="va">doc23</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_put.html">am_put</a></span><span class="op">(</span><span class="va">doc23</span>, <span class="va">AM_ROOT</span>, <span class="st">"items"</span>, <span class="va">AM_OBJ_TYPE_LIST</span><span class="op">)</span></span>
<span><span class="va">items23</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get.html">am_get</a></span><span class="op">(</span><span class="va">doc23</span>, <span class="va">AM_ROOT</span>, <span class="st">"items"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_put.html">am_put</a></span><span class="op">(</span><span class="va">doc23</span>, <span class="va">items23</span>, <span class="st">"end"</span>, <span class="st">"A"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_put.html">am_put</a></span><span class="op">(</span><span class="va">doc23</span>, <span class="va">items23</span>, <span class="st">"end"</span>, <span class="st">"B"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_put.html">am_put</a></span><span class="op">(</span><span class="va">doc23</span>, <span class="va">items23</span>, <span class="st">"end"</span>, <span class="st">"C"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc23</span><span class="op">)</span></span>
<span></span>
<span><span class="va">doc24</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_fork.html">am_fork</a></span><span class="op">(</span><span class="va">doc23</span><span class="op">)</span></span>
<span><span class="va">items24</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get.html">am_get</a></span><span class="op">(</span><span class="va">doc24</span>, <span class="va">AM_ROOT</span>, <span class="st">"items"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/am_delete.html">am_delete</a></span><span class="op">(</span><span class="va">doc23</span>, <span class="va">items23</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_insert.html">am_insert</a></span><span class="op">(</span><span class="va">doc24</span>, <span class="va">items24</span>, <span class="fl">2</span>, <span class="st">"X"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/am_merge.html">am_merge</a></span><span class="op">(</span><span class="va">doc23</span>, <span class="va">doc24</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="../reference/am_length.html">am_length</a></span><span class="op">(</span><span class="va">doc23</span>, <span class="va">items23</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="../reference/am_get.html">am_get</a></span><span class="op">(</span><span class="va">doc23</span>, <span class="va">items23</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] "A"</span></span>
<span><span class="co">#&gt; [1] "X"</span></span>
<span><span class="co">#&gt; [1] "C"</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="best-practices">Best Practices<a class="anchor" aria-label="anchor" href="#best-practices"></a>
</h2>
<div class="section level3">
<h3 id="choose-the-right-crdt-type">1. Choose the Right CRDT Type<a class="anchor" aria-label="anchor" href="#choose-the-right-crdt-type"></a>
</h3>
<ul>
<li>
<strong>Simple values</strong>: Use regular types (strings, numbers,
booleans)</li>
<li>
<strong>Structured data</strong>: Use maps for objects with
independent fields</li>
<li>
<strong>Ordered collections</strong>: Use lists for sequences</li>
<li>
<strong>Collaborative text</strong>: Use text objects, not
strings</li>
<li>
<strong>Counters</strong>: Use counter CRDT, not integers</li>
</ul>
</div>
<div class="section level3">
<h3 id="design-for-commutativity">2. Design for Commutativity<a class="anchor" aria-label="anchor" href="#design-for-commutativity"></a>
</h3>
<p>Structure your data so concurrent operations naturally merge
well:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Good: Independent counters per user</span></span>
<span><span class="va">doc_good</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">doc_good</span><span class="op">[[</span><span class="st">"votes"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  alice <span class="op">=</span> <span class="fu"><a href="../reference/am_counter.html">am_counter</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>  bob <span class="op">=</span> <span class="fu"><a href="../reference/am_counter.html">am_counter</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Better than: Single counter for all votes</span></span>
<span><span class="va">doc_bad</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">doc_bad</span><span class="op">[[</span><span class="st">"total_votes"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_counter.html">am_counter</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span> <span class="co"># Loses attribution</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="commit-at-logical-boundaries">3. Commit at Logical Boundaries<a class="anchor" aria-label="anchor" href="#commit-at-logical-boundaries"></a>
</h3>
<p>Group related changes in commits:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doc25</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Good: Atomic transaction</span></span>
<span><span class="va">doc25</span><span class="op">[[</span><span class="st">"user"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Alice"</span>, age <span class="op">=</span> <span class="fl">30L</span>, city <span class="op">=</span> <span class="st">"Boston"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc25</span>, <span class="st">"Add user Alice"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Bad: Many micro-commits (increases storage)</span></span>
<span><span class="va">doc25</span><span class="op">[[</span><span class="st">"status"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"active"</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc25</span>, <span class="st">"Set status"</span><span class="op">)</span></span>
<span><span class="va">doc25</span><span class="op">[[</span><span class="st">"role"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"admin"</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc25</span>, <span class="st">"Set role"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="handle-concurrent-conflicts-gracefully">4. Handle Concurrent Conflicts Gracefully<a class="anchor" aria-label="anchor" href="#handle-concurrent-conflicts-gracefully"></a>
</h3>
<p>Understand that some conflicts are inevitable:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doc26</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">doc26</span><span class="op">[[</span><span class="st">"status"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"draft"</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc26</span><span class="op">)</span></span>
<span></span>
<span><span class="va">doc27</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_fork.html">am_fork</a></span><span class="op">(</span><span class="va">doc26</span><span class="op">)</span></span>
<span></span>
<span><span class="va">doc26</span><span class="op">[[</span><span class="st">"status"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"published"</span></span>
<span><span class="va">doc27</span><span class="op">[[</span><span class="st">"status"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"archived"</span></span>
<span></span>
<span><span class="fu"><a href="../reference/am_merge.html">am_merge</a></span><span class="op">(</span><span class="va">doc26</span>, <span class="va">doc27</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># One will win - application should handle both states sensibly</span></span>
<span><span class="va">doc26</span><span class="op">[[</span><span class="st">"status"</span><span class="op">]</span><span class="op">]</span> <span class="co"># Should be prepared for either 'published' or 'archived'</span></span>
<span><span class="co">#&gt; [1] "archived"</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="further-reading">Further Reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<ul>
<li><a href="https://automerge.org/" class="external-link">Automerge Documentation</a></li>
<li><a href="https://crdt.tech/" class="external-link">CRDT Research Papers</a></li>
<li><a href="https://arxiv.org/abs/1805.06358" class="external-link">Conflict-Free Replicated
Data Types (Paper)</a></li>
</ul>
</div>
<div class="section level2">
<h2 id="next-steps">Next Steps<a class="anchor" aria-label="anchor" href="#next-steps"></a>
</h2>
<ul>
<li>Learn about <a href="sync-protocol.html">Synchronization
Patterns</a> to use CRDTs in practice</li>
<li>Check the <a href="very-quick-reference.html">Quick Reference</a>
for all available functions</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/shikokuchuo" class="external-link">Charlie Gao</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

  </div></footer>
</body>
</html>

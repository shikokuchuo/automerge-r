<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Synchronization Protocol • automerge</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Synchronization Protocol">
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">automerge</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/automerge.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/crdt-concepts.html">Understanding CRDTs in Automerge</a></li>
    <li><a class="dropdown-item" href="../articles/sync-protocol.html">Synchronization Protocol</a></li>
    <li><a class="dropdown-item" href="../articles/very-quick-reference.html">Quick Reference</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/shikokuchuo/automerge-r/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Synchronization Protocol</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/shikokuchuo/automerge-r/blob/main/vignettes/sync-protocol.Rmd" class="external-link"><code>vignettes/sync-protocol.Rmd</code></a></small>
      <div class="d-none name"><code>sync-protocol.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/shikokuchuo/automerge-r" class="external-link">automerge</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>Automerge’s synchronization protocol enables multiple peers to
exchange changes and converge to the same document state. The protocol
is efficient, handling only missing changes between peers, and works
over any transport (files, HTTP, WebSockets, etc.).</p>
</div>
<div class="section level2">
<h2 id="high-level-sync-recommended">High-Level Sync (Recommended)<a class="anchor" aria-label="anchor" href="#high-level-sync-recommended"></a>
</h2>
<p>For most use cases, use the high-level sync helpers that handle the
protocol automatically.</p>
<div class="section level3">
<h3 id="bidirectional-sync">Bidirectional Sync<a class="anchor" aria-label="anchor" href="#bidirectional-sync"></a>
</h3>
<p>The simplest way to synchronize two documents:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create two peers with different data</span></span>
<span><span class="va">peer1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">peer1</span><span class="op">[[</span><span class="st">"edited_by"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"peer1"</span></span>
<span><span class="va">peer1</span><span class="op">[[</span><span class="st">"data1"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">peer1</span>, <span class="st">"Peer1 changes"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">peer2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">peer2</span><span class="op">[[</span><span class="st">"edited_by"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"peer2"</span></span>
<span><span class="va">peer2</span><span class="op">[[</span><span class="st">"data2"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">200</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">peer2</span>, <span class="st">"Peer2 changes"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Automatic bidirectional sync (documents modified in place)</span></span>
<span><span class="va">rounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_sync.html">am_sync</a></span><span class="op">(</span><span class="va">peer1</span>, <span class="va">peer2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rounds</span></span>
<span><span class="co">#&gt; [1] 4</span></span>
<span></span>
<span><span class="co"># Both documents now have all data</span></span>
<span><span class="va">peer1</span><span class="op">[[</span><span class="st">"data1"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 100</span></span>
<span><span class="va">peer1</span><span class="op">[[</span><span class="st">"data2"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 200</span></span>
<span><span class="va">peer2</span><span class="op">[[</span><span class="st">"data1"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 100</span></span>
<span><span class="va">peer2</span><span class="op">[[</span><span class="st">"data2"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 200</span></span></code></pre></div>
<p><strong>When to use</strong>: Simple peer-to-peer synchronization
where both sides need all changes.</p>
</div>
<div class="section level3">
<h3 id="one-way-merge">One-Way Merge<a class="anchor" aria-label="anchor" href="#one-way-merge"></a>
</h3>
<p>For pulling changes from one document to another without sending
changes back:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create source document</span></span>
<span><span class="va">source</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">source</span><span class="op">[[</span><span class="st">"version"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"2.0"</span></span>
<span><span class="va">source</span><span class="op">[[</span><span class="st">"features"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"auth"</span>, <span class="st">"api"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">source</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create target document</span></span>
<span><span class="va">target</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">target</span><span class="op">[[</span><span class="st">"version"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"1.0"</span></span>
<span><span class="va">target</span><span class="op">[[</span><span class="st">"development"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">target</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Pull changes from source to target</span></span>
<span><span class="fu"><a href="../reference/am_merge.html">am_merge</a></span><span class="op">(</span><span class="va">target</span>, <span class="va">source</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Target now has source's changes</span></span>
<span><span class="va">target</span><span class="op">[[</span><span class="st">"version"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "1.0"</span></span>
<span></span>
<span><span class="co"># Source is unchanged</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">source</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "features" "version"</span></span></code></pre></div>
<p><strong>When to use</strong>: Client pulling updates from server,
importing changes from another peer.</p>
</div>
</div>
<div class="section level2">
<h2 id="low-level-sync-protocol">Low-Level Sync Protocol<a class="anchor" aria-label="anchor" href="#low-level-sync-protocol"></a>
</h2>
<p>For network protocols or fine-grained control, use the low-level
API.</p>
<div class="section level3">
<h3 id="basic-protocol-flow">Basic Protocol Flow<a class="anchor" aria-label="anchor" href="#basic-protocol-flow"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create two peers</span></span>
<span><span class="va">peer3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">peer3</span><span class="op">[[</span><span class="st">"source"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"peer3"</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">peer3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">peer4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">peer4</span><span class="op">[[</span><span class="st">"source"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"peer4"</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">peer4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Each peer maintains its own sync state</span></span>
<span><span class="va">sync3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_sync_state_new.html">am_sync_state_new</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sync4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_sync_state_new.html">am_sync_state_new</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Exchange messages until converged</span></span>
<span><span class="va">round</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="kw">repeat</span> <span class="op">{</span></span>
<span>  <span class="va">round</span> <span class="op">&lt;-</span> <span class="va">round</span> <span class="op">+</span> <span class="fl">1</span></span>
<span></span>
<span>  <span class="co"># Peer 3 generates message</span></span>
<span>  <span class="va">msg3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_sync_encode.html">am_sync_encode</a></span><span class="op">(</span><span class="va">peer3</span>, <span class="va">sync3</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">msg3</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">break</span></span>
<span>  <span class="op">}</span> <span class="co"># No more messages</span></span>
<span></span>
<span>  <span class="co"># Peer 4 receives and processes</span></span>
<span>  <span class="fu"><a href="../reference/am_sync_decode.html">am_sync_decode</a></span><span class="op">(</span><span class="va">peer4</span>, <span class="va">sync4</span>, <span class="va">msg3</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Peer 4 generates response</span></span>
<span>  <span class="va">msg4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_sync_encode.html">am_sync_encode</a></span><span class="op">(</span><span class="va">peer4</span>, <span class="va">sync4</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">msg4</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">break</span></span>
<span>  <span class="op">}</span> <span class="co"># No more messages</span></span>
<span></span>
<span>  <span class="co"># Peer 3 receives and processes</span></span>
<span>  <span class="fu"><a href="../reference/am_sync_decode.html">am_sync_decode</a></span><span class="op">(</span><span class="va">peer3</span>, <span class="va">sync3</span>, <span class="va">msg4</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">round</span> <span class="op">&gt;</span> <span class="fl">100</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"Sync did not converge in 100 rounds"</span><span class="op">)</span></span>
<span>    <span class="kw">break</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">round</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="va">peer3</span><span class="op">[[</span><span class="st">"source"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "peer4"</span></span>
<span><span class="va">peer4</span><span class="op">[[</span><span class="st">"source"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "peer4"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="protocol-components">Protocol Components<a class="anchor" aria-label="anchor" href="#protocol-components"></a>
</h3>
<p><strong>Sync State</strong> (<code><a href="../reference/am_sync_state_new.html">am_sync_state_new()</a></code>):</p>
<ul>
<li>Tracks what each peer knows</li>
<li>Document-independent (can be reused)</li>
<li>Should be preserved across sessions for efficiency</li>
</ul>
<p><strong>Sync Encode</strong>
(<code>am_sync_encode(doc, sync_state)</code>):</p>
<ul>
<li>Generates sync message to send to peer</li>
<li>Returns <code>NULL</code> when no more changes to send</li>
<li>Message is binary (raw vector)</li>
</ul>
<p><strong>Sync Decode</strong>
(<code>am_sync_decode(doc, sync_state, message)</code>):</p>
<ul>
<li>Receives sync message from peer</li>
<li>Updates document and sync state</li>
<li>Returns document invisibly for chaining</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="change-based-synchronization">Change-Based Synchronization<a class="anchor" aria-label="anchor" href="#change-based-synchronization"></a>
</h2>
<p>For scenarios where you want explicit control over individual
changes:</p>
<div class="section level3">
<h3 id="exporting-and-importing-changes">Exporting and Importing Changes<a class="anchor" aria-label="anchor" href="#exporting-and-importing-changes"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create base document that will be shared</span></span>
<span><span class="va">base_doc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">base_doc</span><span class="op">[[</span><span class="st">"v1"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"first"</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">base_doc</span>, <span class="st">"Version 1"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fork to create two peers with shared history</span></span>
<span><span class="va">peer_a</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_fork.html">am_fork</a></span><span class="op">(</span><span class="va">base_doc</span><span class="op">)</span></span>
<span><span class="va">peer_b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_fork.html">am_fork</a></span><span class="op">(</span><span class="va">base_doc</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Remember the fork point</span></span>
<span><span class="va">fork_heads</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get_heads.html">am_get_heads</a></span><span class="op">(</span><span class="va">peer_a</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Peer A makes changes</span></span>
<span><span class="va">peer_a</span><span class="op">[[</span><span class="st">"v2"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"second"</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">peer_a</span>, <span class="st">"Version 2"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">peer_a</span><span class="op">[[</span><span class="st">"v3"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"third"</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">peer_a</span>, <span class="st">"Version 3"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Export changes since fork point</span></span>
<span><span class="va">changes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get_changes.html">am_get_changes</a></span><span class="op">(</span><span class="va">peer_a</span>, <span class="va">fork_heads</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">changes</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span></span>
<span><span class="co"># Peer B applies the changes</span></span>
<span><span class="fu"><a href="../reference/am_apply_changes.html">am_apply_changes</a></span><span class="op">(</span><span class="va">peer_b</span>, <span class="va">changes</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Verify both peers are in sync</span></span>
<span><span class="va">peer_b</span><span class="op">[[</span><span class="st">"v2"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "second"</span></span>
<span><span class="va">peer_b</span><span class="op">[[</span><span class="st">"v3"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "third"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="saving-changes-to-files">Saving Changes to Files<a class="anchor" aria-label="anchor" href="#saving-changes-to-files"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Save individual changes to files</span></span>
<span><span class="va">temp_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">changes</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">change_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">temp_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"change_%03d.bin"</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readBin.html" class="external-link">writeBin</a></span><span class="op">(</span><span class="va">changes</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="va">change_file</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Later: load and apply changes</span></span>
<span><span class="va">loaded_changes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">changes</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">change_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">temp_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"change_%03d.bin"</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">loaded_changes</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readBin.html" class="external-link">readBin</a></span><span class="op">(</span><span class="va">change_file</span>, <span class="st">"raw"</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.info.html" class="external-link">file.size</a></span><span class="op">(</span><span class="va">change_file</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Apply loaded changes to a peer</span></span>
<span><span class="va">peer_c</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_fork.html">am_fork</a></span><span class="op">(</span><span class="va">base_doc</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_apply_changes.html">am_apply_changes</a></span><span class="op">(</span><span class="va">peer_c</span>, <span class="va">loaded_changes</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Verify</span></span>
<span><span class="va">peer_c</span><span class="op">[[</span><span class="st">"v3"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "third"</span></span></code></pre></div>
<p><strong>When to use</strong>: Git-like workflows, change logs,
selective sync.</p>
</div>
</div>
<div class="section level2">
<h2 id="document-heads-and-history">Document Heads and History<a class="anchor" aria-label="anchor" href="#document-heads-and-history"></a>
</h2>
<div class="section level3">
<h3 id="understanding-heads">Understanding Heads<a class="anchor" aria-label="anchor" href="#understanding-heads"></a>
</h3>
<p><strong>Heads</strong> are the most recent commits in a document’s
history. They represent the current state’s frontier in the change
graph.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create document and make changes</span></span>
<span><span class="va">doc_main</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">doc_main</span><span class="op">[[</span><span class="st">"version"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"1.0"</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc_main</span>, <span class="st">"Initial version"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get heads (fingerprint of current state)</span></span>
<span><span class="va">heads_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get_heads.html">am_get_heads</a></span><span class="op">(</span><span class="va">doc_main</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">heads_v1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span></span>
<span><span class="co"># Make more changes</span></span>
<span><span class="va">doc_main</span><span class="op">[[</span><span class="st">"version"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"2.0"</span></span>
<span><span class="va">doc_main</span><span class="op">[[</span><span class="st">"feature"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"new"</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc_main</span>, <span class="st">"Version 2"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">heads_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get_heads.html">am_get_heads</a></span><span class="op">(</span><span class="va">doc_main</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">heads_v1</span>, <span class="va">heads_v2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<p>Heads are useful for:</p>
<ul>
<li>Tracking which changes you’ve already seen</li>
<li>Computing incremental updates</li>
<li>Detecting whether documents have diverged</li>
</ul>
</div>
<div class="section level3">
<h3 id="working-with-history">Working with History<a class="anchor" aria-label="anchor" href="#working-with-history"></a>
</h3>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get full change history</span></span>
<span><span class="va">history</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get_history.html">am_get_history</a></span><span class="op">(</span><span class="va">doc_main</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">history</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span></span>
<span><span class="co"># History includes all commits ever made</span></span>
<span><span class="co"># Each entry contains metadata about a commit</span></span>
<span></span>
<span><span class="co"># Get changes between two points in history</span></span>
<span><span class="va">changes_since_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get_changes.html">am_get_changes</a></span><span class="op">(</span><span class="va">doc_main</span>, <span class="va">heads_v1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">changes_since_v1</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 1</span></span>
<span><span class="co">#&gt;  $ : raw [1:126] 85 6f 4a 83 ...</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="incremental-sync-pattern">Incremental Sync Pattern<a class="anchor" aria-label="anchor" href="#incremental-sync-pattern"></a>
</h3>
<p>Common pattern: track last sync point and only send new changes</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Server document that accumulates changes</span></span>
<span><span class="va">server</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">server</span><span class="op">[[</span><span class="st">"users"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0L</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">server</span>, <span class="st">"Initialize"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Client syncs and remembers server state</span></span>
<span><span class="va">client</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_fork.html">am_fork</a></span><span class="op">(</span><span class="va">server</span><span class="op">)</span></span>
<span><span class="va">last_sync_heads</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get_heads.html">am_get_heads</a></span><span class="op">(</span><span class="va">server</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Client makes local changes</span></span>
<span><span class="va">client</span><span class="op">[[</span><span class="st">"users"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1L</span></span>
<span><span class="va">client</span><span class="op">[[</span><span class="st">"local_cache"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">client</span>, <span class="st">"Client updates"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Server receives changes from other clients</span></span>
<span><span class="va">server</span><span class="op">[[</span><span class="st">"users"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">5L</span></span>
<span><span class="va">server</span><span class="op">[[</span><span class="st">"server_config"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"production"</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">server</span>, <span class="st">"Server updates"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Client pulls only new server changes since last sync</span></span>
<span><span class="va">new_changes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get_changes.html">am_get_changes</a></span><span class="op">(</span><span class="va">server</span>, <span class="va">last_sync_heads</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">new_changes</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span></span>
<span><span class="fu"><a href="../reference/am_apply_changes.html">am_apply_changes</a></span><span class="op">(</span><span class="va">client</span>, <span class="va">new_changes</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Update sync point</span></span>
<span><span class="va">last_sync_heads</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get_heads.html">am_get_heads</a></span><span class="op">(</span><span class="va">server</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Client now has server's changes</span></span>
<span><span class="va">client</span><span class="op">[[</span><span class="st">"server_config"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "production"</span></span>
<span></span>
<span><span class="co"># Server can also pull client's changes</span></span>
<span><span class="va">client_changes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get_changes.html">am_get_changes</a></span><span class="op">(</span><span class="va">client</span>, <span class="fu"><a href="../reference/am_get_heads.html">am_get_heads</a></span><span class="op">(</span><span class="va">server</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_apply_changes.html">am_apply_changes</a></span><span class="op">(</span><span class="va">server</span>, <span class="va">client_changes</span><span class="op">)</span></span>
<span></span>
<span><span class="va">server</span><span class="op">[[</span><span class="st">"local_cache"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="detecting-divergence">Detecting Divergence<a class="anchor" aria-label="anchor" href="#detecting-divergence"></a>
</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create two peers that will diverge</span></span>
<span><span class="va">peer_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">peer_x</span><span class="op">[[</span><span class="st">"id"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"x"</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">peer_x</span><span class="op">)</span></span>
<span></span>
<span><span class="va">peer_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_fork.html">am_fork</a></span><span class="op">(</span><span class="va">peer_x</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Remember common state</span></span>
<span><span class="va">common_heads</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get_heads.html">am_get_heads</a></span><span class="op">(</span><span class="va">peer_x</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Both make different changes</span></span>
<span><span class="va">peer_x</span><span class="op">[[</span><span class="st">"data_x"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"from X"</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">peer_x</span>, <span class="st">"X's change"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">peer_y</span><span class="op">[[</span><span class="st">"data_y"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"from Y"</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">peer_y</span>, <span class="st">"Y's change"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check if they've diverged</span></span>
<span><span class="va">x_heads</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get_heads.html">am_get_heads</a></span><span class="op">(</span><span class="va">peer_x</span><span class="op">)</span></span>
<span><span class="va">y_heads</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get_heads.html">am_get_heads</a></span><span class="op">(</span><span class="va">peer_y</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">x_heads</span>, <span class="va">y_heads</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span></span>
<span><span class="co"># Get each peer's changes since common state</span></span>
<span><span class="va">x_changes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get_changes.html">am_get_changes</a></span><span class="op">(</span><span class="va">peer_x</span>, <span class="va">common_heads</span><span class="op">)</span></span>
<span><span class="va">y_changes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_get_changes.html">am_get_changes</a></span><span class="op">(</span><span class="va">peer_y</span>, <span class="va">common_heads</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">x_changes</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 1</span></span>
<span><span class="co">#&gt;  $ : raw [1:109] 85 6f 4a 83 ...</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">y_changes</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 1</span></span>
<span><span class="co">#&gt;  $ : raw [1:109] 85 6f 4a 83 ...</span></span>
<span></span>
<span><span class="co"># Sync to merge divergent histories</span></span>
<span><span class="va">rounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_sync.html">am_sync</a></span><span class="op">(</span><span class="va">peer_x</span>, <span class="va">peer_y</span><span class="op">)</span></span>
<span><span class="va">rounds</span></span>
<span><span class="co">#&gt; [1] 4</span></span>
<span></span>
<span><span class="co"># After sync, heads are identical again</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="fu"><a href="../reference/am_get_heads.html">am_get_heads</a></span><span class="op">(</span><span class="va">peer_x</span><span class="op">)</span>, <span class="fu"><a href="../reference/am_get_heads.html">am_get_heads</a></span><span class="op">(</span><span class="va">peer_y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="concurrent-edits">Concurrent Edits<a class="anchor" aria-label="anchor" href="#concurrent-edits"></a>
</h2>
<p>Understanding how concurrent edits merge:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create shared starting point</span></span>
<span><span class="va">base</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">base</span><span class="op">[[</span><span class="st">"counter"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_counter.html">am_counter</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">base</span><span class="op">[[</span><span class="st">"status"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"draft"</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">base</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fork to two editors</span></span>
<span><span class="va">editor1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_fork.html">am_fork</a></span><span class="op">(</span><span class="va">base</span><span class="op">)</span></span>
<span><span class="va">editor2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_fork.html">am_fork</a></span><span class="op">(</span><span class="va">base</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Concurrent edits</span></span>
<span><span class="co"># Editor 1: increment counter, change status</span></span>
<span><span class="fu"><a href="../reference/am_counter_increment.html">am_counter_increment</a></span><span class="op">(</span><span class="va">editor1</span>, <span class="va">AM_ROOT</span>, <span class="st">"counter"</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">editor1</span><span class="op">[[</span><span class="st">"status"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"review"</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">editor1</span>, <span class="st">"Editor 1 changes"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Editor 2: increment counter differently, change status differently</span></span>
<span><span class="fu"><a href="../reference/am_counter_increment.html">am_counter_increment</a></span><span class="op">(</span><span class="va">editor2</span>, <span class="va">AM_ROOT</span>, <span class="st">"counter"</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">editor2</span><span class="op">[[</span><span class="st">"status"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"published"</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">editor2</span>, <span class="st">"Editor 2 changes"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sync editors</span></span>
<span><span class="va">rounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_sync.html">am_sync</a></span><span class="op">(</span><span class="va">editor1</span>, <span class="va">editor2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Counter: Both increments sum (CRDT)</span></span>
<span><span class="va">editor1</span><span class="op">[[</span><span class="st">"counter"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; &lt;Automerge Counter: 8 &gt;</span></span>
<span></span>
<span><span class="co"># Status: Deterministic conflict resolution (one value wins)</span></span>
<span><span class="va">editor1</span><span class="op">[[</span><span class="st">"status"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "review"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="sync-performance">Sync Performance<a class="anchor" aria-label="anchor" href="#sync-performance"></a>
</h2>
<div class="section level3">
<h3 id="the-sync-frequency-tradeoff">The Sync Frequency Tradeoff<a class="anchor" aria-label="anchor" href="#the-sync-frequency-tradeoff"></a>
</h3>
<p>There’s a fundamental tradeoff between <em>collaboration latency</em>
and <em>efficiency</em>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Strategy A: Frequent sync (lower latency, more overhead)</span></span>
<span><span class="va">doc_frequent</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">peer_frequent</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sync_count_frequent</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">doc_frequent</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"k"</span>, <span class="va">i</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">i</span></span>
<span>  <span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc_frequent</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Change"</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">rounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_sync.html">am_sync</a></span><span class="op">(</span><span class="va">doc_frequent</span>, <span class="va">peer_frequent</span><span class="op">)</span></span>
<span>  <span class="va">sync_count_frequent</span> <span class="op">&lt;-</span> <span class="va">sync_count_frequent</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># 10 separate commits, 10 sync operations</span></span>
<span><span class="va">sync_count_frequent</span></span>
<span><span class="co">#&gt; [1] 10</span></span>
<span></span>
<span><span class="co"># Strategy B: Batched commits (higher latency, less overhead)</span></span>
<span><span class="va">doc_batched</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">peer_batched</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Batch all changes into one commit</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">doc_batched</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"k"</span>, <span class="va">i</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">i</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc_batched</span>, <span class="st">"Batch of 10 changes"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_sync.html">am_sync</a></span><span class="op">(</span><span class="va">doc_batched</span>, <span class="va">peer_batched</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 1 commit, 1 sync operation</span></span>
<span><span class="va">rounds</span></span>
<span><span class="co">#&gt; [1] 4</span></span>
<span></span>
<span><span class="co"># Compare document sizes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="../reference/am_save.html">am_save</a></span><span class="op">(</span><span class="va">doc_frequent</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 265</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="../reference/am_save.html">am_save</a></span><span class="op">(</span><span class="va">doc_batched</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 186</span></span></code></pre></div>
<p><strong>Batching creates smaller documents</strong> because:</p>
<ul>
<li>Fewer commit metadata entries</li>
<li>Better compression of related changes</li>
<li>Less overhead from commit boundaries</li>
</ul>
</div>
<div class="section level3">
<h3 id="choosing-a-strategy">Choosing a Strategy<a class="anchor" aria-label="anchor" href="#choosing-a-strategy"></a>
</h3>
<p><strong>Use frequent syncs when:</strong></p>
<ul>
<li>Multiple users editing simultaneously</li>
<li>Low-latency collaboration is critical (real-time editing)</li>
<li>Users need to see each other’s changes quickly</li>
<li>Working over reliable, fast networks</li>
</ul>
<p><strong>Use batched commits when:</strong></p>
<ul>
<li>Single user making many changes</li>
<li>Optimizing for storage/bandwidth</li>
<li>Syncing over slow or metered connections</li>
<li>Changes are logically related (e.g., form submission)</li>
</ul>
<p><strong>Hybrid approach</strong> (recommended for most cases):</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Batch related changes, sync periodically</span></span>
<span><span class="va">doc_hybrid</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># User fills out a form (batch these)</span></span>
<span><span class="va">doc_hybrid</span><span class="op">[[</span><span class="st">"name"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Alice"</span></span>
<span><span class="va">doc_hybrid</span><span class="op">[[</span><span class="st">"email"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"alice@example.com"</span></span>
<span><span class="va">doc_hybrid</span><span class="op">[[</span><span class="st">"preferences"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"theme"</span> <span class="op">=</span> <span class="st">"dark"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc_hybrid</span>, <span class="st">"Update user profile"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sync after logical unit of work</span></span>
<span><span class="co"># result &lt;- sync_with_server(doc_hybrid)</span></span>
<span></span>
<span><span class="co"># Later: another logical unit</span></span>
<span><span class="va">doc_hybrid</span><span class="op">[[</span><span class="st">"last_login"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc_hybrid</span>, <span class="st">"Record login"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sync again</span></span>
<span><span class="co"># result &lt;- sync_with_server(doc_hybrid)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="reusing-sync-state">Reusing Sync State<a class="anchor" aria-label="anchor" href="#reusing-sync-state"></a>
</h3>
<p>Sync state tracks what each peer has seen, enabling efficient
incremental sync:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Without reusing sync state (inefficient)</span></span>
<span><span class="va">doc_no_reuse</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">doc_no_reuse</span><span class="op">[[</span><span class="st">"v1"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc_no_reuse</span><span class="op">)</span></span>
<span></span>
<span><span class="va">peer_no_reuse</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># First sync</span></span>
<span><span class="va">rounds1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_sync.html">am_sync</a></span><span class="op">(</span><span class="va">doc_no_reuse</span>, <span class="va">peer_no_reuse</span><span class="op">)</span></span>
<span><span class="va">rounds1</span></span>
<span><span class="co">#&gt; [1] 4</span></span>
<span></span>
<span><span class="co"># Add more changes</span></span>
<span><span class="va">doc_no_reuse</span><span class="op">[[</span><span class="st">"v2"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc_no_reuse</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Second sync (creates new sync state, may resend some data)</span></span>
<span><span class="va">rounds2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_sync.html">am_sync</a></span><span class="op">(</span><span class="va">doc_no_reuse</span>, <span class="va">peer_no_reuse</span><span class="op">)</span></span>
<span><span class="va">rounds2</span></span>
<span><span class="co">#&gt; [1] 4</span></span>
<span></span>
<span><span class="co"># With reusing sync state (efficient)</span></span>
<span><span class="va">doc_reuse</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">doc_reuse</span><span class="op">[[</span><span class="st">"v1"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc_reuse</span><span class="op">)</span></span>
<span></span>
<span><span class="va">peer_reuse</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sync_state_local</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_sync_state_new.html">am_sync_state_new</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sync_state_peer</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_sync_state_new.html">am_sync_state_new</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Manual sync with persistent state</span></span>
<span><span class="va">msg1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_sync_encode.html">am_sync_encode</a></span><span class="op">(</span><span class="va">doc_reuse</span>, <span class="va">sync_state_local</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_sync_decode.html">am_sync_decode</a></span><span class="op">(</span><span class="va">peer_reuse</span>, <span class="va">sync_state_peer</span>, <span class="va">msg1</span><span class="op">)</span></span>
<span><span class="va">msg2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_sync_encode.html">am_sync_encode</a></span><span class="op">(</span><span class="va">peer_reuse</span>, <span class="va">sync_state_peer</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">msg2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/am_sync_decode.html">am_sync_decode</a></span><span class="op">(</span><span class="va">doc_reuse</span>, <span class="va">sync_state_local</span>, <span class="va">msg2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Add more changes</span></span>
<span><span class="va">doc_reuse</span><span class="op">[[</span><span class="st">"v2"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc_reuse</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Second sync reuses state (only sends new changes)</span></span>
<span><span class="va">msg3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_sync_encode.html">am_sync_encode</a></span><span class="op">(</span><span class="va">doc_reuse</span>, <span class="va">sync_state_local</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/am_sync_decode.html">am_sync_decode</a></span><span class="op">(</span><span class="va">peer_reuse</span>, <span class="va">sync_state_peer</span>, <span class="va">msg3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sync state remembers what was already exchanged</span></span></code></pre></div>
<p><strong>When to persist sync state:</strong></p>
<ul>
<li>Long-lived connections (WebSocket servers)</li>
<li>Periodic sync jobs (cron, scheduled tasks)</li>
<li>Client apps that reconnect frequently</li>
<li>Reduces redundant data transfer significantly</li>
</ul>
</div>
<div class="section level3">
<h3 id="measuring-performance">Measuring Performance<a class="anchor" aria-label="anchor" href="#measuring-performance"></a>
</h3>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compare efficiency of different approaches</span></span>
<span><span class="va">measure_sync</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n_changes</span>, <span class="va">batch_size</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">doc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">peer</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_create.html">am_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">changes_made</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">syncs_performed</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_changes</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">doc</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"k"</span>, <span class="va">i</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">i</span></span>
<span>    <span class="va">changes_made</span> <span class="op">&lt;-</span> <span class="va">changes_made</span> <span class="op">+</span> <span class="fl">1</span></span>
<span></span>
<span>    <span class="co"># Commit every batch_size changes</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">changes_made</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="va">batch_size</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Batch at %d"</span>, <span class="va">changes_made</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">rounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_sync.html">am_sync</a></span><span class="op">(</span><span class="va">doc</span>, <span class="va">peer</span><span class="op">)</span></span>
<span>      <span class="va">syncs_performed</span> <span class="op">&lt;-</span> <span class="va">syncs_performed</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Final commit if needed</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">changes_made</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="va">batch_size</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/am_commit.html">am_commit</a></span><span class="op">(</span><span class="va">doc</span>, <span class="st">"Final batch"</span><span class="op">)</span></span>
<span>    <span class="va">rounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/am_sync.html">am_sync</a></span><span class="op">(</span><span class="va">doc</span>, <span class="va">peer</span><span class="op">)</span></span>
<span>    <span class="va">syncs_performed</span> <span class="op">&lt;-</span> <span class="va">syncs_performed</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    changes <span class="op">=</span> <span class="va">changes_made</span>,</span>
<span>    syncs <span class="op">=</span> <span class="va">syncs_performed</span>,</span>
<span>    size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="../reference/am_save.html">am_save</a></span><span class="op">(</span><span class="va">doc</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># No batching: commit and sync after every change</span></span>
<span><span class="va">result_no_batch</span> <span class="op">&lt;-</span> <span class="fu">measure_sync</span><span class="op">(</span><span class="fl">20</span>, <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Medium batching: commit every 5 changes</span></span>
<span><span class="va">result_medium</span> <span class="op">&lt;-</span> <span class="fu">measure_sync</span><span class="op">(</span><span class="fl">20</span>, <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Full batching: single commit at end</span></span>
<span><span class="va">result_full</span> <span class="op">&lt;-</span> <span class="fu">measure_sync</span><span class="op">(</span><span class="fl">20</span>, <span class="fl">20</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare results</span></span>
<span><span class="va">result_no_batch</span><span class="op">$</span><span class="va">syncs</span></span>
<span><span class="co">#&gt; [1] 20</span></span>
<span><span class="va">result_medium</span><span class="op">$</span><span class="va">syncs</span></span>
<span><span class="co">#&gt; [1] 4</span></span>
<span><span class="va">result_full</span><span class="op">$</span><span class="va">syncs</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span></span>
<span><span class="co"># Document sizes</span></span>
<span><span class="va">result_no_batch</span><span class="op">$</span><span class="va">size</span></span>
<span><span class="co">#&gt; [1] 461</span></span>
<span><span class="va">result_medium</span><span class="op">$</span><span class="va">size</span></span>
<span><span class="co">#&gt; [1] 276</span></span>
<span><span class="va">result_full</span><span class="op">$</span><span class="va">size</span></span>
<span><span class="co">#&gt; [1] 233</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="next-steps">Next Steps<a class="anchor" aria-label="anchor" href="#next-steps"></a>
</h2>
<ul>
<li>Learn about <a href="crdt-concepts.html">CRDT Concepts</a> to
understand merge behavior</li>
<li>Check the <a href="very-quick-reference.html">Quick Reference</a>
for all sync functions</li>
</ul>
</div>
<div class="section level2">
<h2 id="further-reading">Further Reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<ul>
<li><a href="https://www.inkandswitch.com/local-first/" class="external-link">Local-First
Software</a></li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/shikokuchuo" class="external-link">Charlie Gao</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

  </div></footer>
</body>
</html>
